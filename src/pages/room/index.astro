---
import ColumnFields from "@/components/OptionsLayout/ColumnFields.astro";
import Field from "@/components/OptionsLayout/Field.astro";
import Navbar from "@/components/OptionsLayout/Navbar.astro";
import NavbarLink from "@/components/OptionsLayout/Navbar_Link.astro";
import NavbarSep from "@/components/OptionsLayout/Navbar_Sep.astro";
import NavbarTitle from "@/components/OptionsLayout/Navbar_Title.astro";
import Note from "@/components/OptionsLayout/Note.astro";
import Section from "@/components/OptionsLayout/Section.astro";
import Separator from "@/components/OptionsLayout/Separator.astro";
import OptionsLayout from "@/layouts/OptionsLayout.astro";
import type { ChatHistoryOptions } from "@/services/chatHistory";
import type { PubsubOptions } from "@/services/pubsub";
import type { RoomVisOptions } from "@/services/roomVisualization";
import type { TmiOptions } from "@/services/tmi";

export type ChatRoomOptions = PubsubOptions &
	TmiOptions &
	ChatHistoryOptions &
	RoomVisOptions & {
		rewards: { trigger: string, action: string, value?: string }[]
		onlyFollowers?: boolean;
	};
---

<OptionsLayout widgetName="Room" overlayUrl={import.meta.env.BASE_URL + "/room/overlay"}>
	<Navbar slot="aside">
		<NavbarTitle name="Room Widget" />
		<NavbarLink name="General Config" link="#general" />
		<NavbarLink name="Floor Config" link="#floor" />
		<NavbarLink name="Wall Config" link="#wall" />
		<NavbarLink name="Data Layer" link="#data" />
		<NavbarSep />
		<NavbarTitle name="Result" />
		<NavbarLink name="Preview" link="#preview" />
	</Navbar>

	<Section
		id="general"
		title="General Config"
		info="Details in how the room looks"
	>
		<ColumnFields>
			<div>
				<Field
					label="Canvas Width"
					placeholder="Width in pixels"
					type="number"
					id="canvasWidth"
					name="canvasWidth"
					info="The width of the canvas where the room will be rendered in. Default: 800"
				/>
			</div>
			<div>
				<Field
					label="Canvas Height"
					placeholder="Height in pixels"
					type="number"
					id="canvasHeight"
					name="canvasHeight"
					info="The height of the canvas where the room will be rendered in. Default: 600"
				/>
			</div>
		</ColumnFields>
		<ColumnFields>
			<div>
				<Field
					label="Room Coord X"
					placeholder="Position X of the room"
					type="number"
					id="roomCoordX"
					name="roomCoordX"
					info="The position Y where the room will be rendered. Default: 0"
				/>
			</div>
			<div>
				<Field
					label="Room Coord Y"
					placeholder="Position Y of the room"
					type="number"
					id="roomCoordY"
					name="roomCoordY"
					info="The position X where the room will be rendered. Default: 0"
				/>
			</div>
		</ColumnFields>
		<Note info="Keep in mind that in order to display the users correctly, the room should have some additional space above it." />
	</Section>

	<Separator />

	<Section
		id="floor"
		title="Floor Config"
		info="Change how the floor looks in this widget"
	>
		<Field
			label="Hide Floor"
			placeholder="Should the floor be visible?"
			type="checkbox"
			id="hideFloor"
			name="hideFloor"
			info="Hidding the floor will also hide the wall."
		/>
		<Field
			label="Floor Plan"
			placeholder="Paste the floor plan here"
			type="text"
			id="floorPlan"
			name="floorPlan"
			info="Space separated definition of the floor. You can copy and paste from the Habbo editor."
		/>
		<Field
			label="Floor Color"
			placeholder="Choose the color of the floor"
			type="color"
			id="floorColor"
			name="floorColor"
			inputProps={{
				value: "#989865",
			}}
			info="Default: #989865"
		/>
		<Field
			label="Floor Texture"
			placeholder="Choose the floor texture"
			type="radioImage"
			options={[
				{ name: "Default", value: 0, img: import.meta.env.BASE_URL + "/icons/floor_0.png" },
				// { name: "Default", value: 1, img: import.meta.env.BASE_URL + "/icons/floor_1.png" },
				{ name: "Default", value: 2, img: import.meta.env.BASE_URL + "/icons/floor_2.png" },
				{ name: "Default", value: 3, img: import.meta.env.BASE_URL + "/icons/floor_3.png" },
				// { name: "Default", value: 4, img: import.meta.env.BASE_URL + "/icons/floor_4.png" },
				{ name: "Default", value: 5, img: import.meta.env.BASE_URL + "/icons/floor_5.png" },
				{ name: "Default", value: 6, img: import.meta.env.BASE_URL + "/icons/floor__0.png" },
				{ name: "Default", value: 7, img: import.meta.env.BASE_URL + "/icons/floor__1.png" },
			]}
			id="floorTexture"
			name="floorTexture"
		/>
		<ColumnFields>
			<div>
				<Field
					label="Floor Height"
					placeholder="Choose the height of the floor"
					type="number"
					id="floorHeight"
					name="floorHeight"
					info="Default: 8"
				/>
			</div>
			<div></div>
		</ColumnFields>
	</Section>

	<Separator />

	<Section
		id="wall"
		title="Wall Config"
		info="Change how the wall looks in this widget"
	>
		<Field
			label="Hide Walls"
			placeholder="Choose the color of the floor"
			type="checkbox"
			id="hideWalls"
			name="hideWalls"
			inputProps={{
				// checked: true,
			}}
		/>
		<Field
			label="Wall Color"
			placeholder="Choose the color of the wall"
			type="color"
			id="wallColor"
			name="wallColor"
			inputProps={{
				value: "#b6b8c7",
			}}
			info="Default: #b6b8c7"
		/>
		<Field
			label="Wall Texture"
			placeholder="Choose the wall texture"
			type="radioImage"
			options={[
				{ name: "Default (flat)", value: 0, img: import.meta.env.BASE_URL + "/icons/wall_0.png" },
				{ name: "Squares", value: 1, img: import.meta.env.BASE_URL + "/icons/wall_1.png" },
				{ name: "Bigger squares", value: 2, img: import.meta.env.BASE_URL + "/icons/wall_2.png" },
				// { name: "Default", value: 3, img: import.meta.env.BASE_URL + "/icons/wall_3.png" },
				{ name: "Horizontal lines", value: 4, img: import.meta.env.BASE_URL + "/icons/wall_4.png" },
				{ name: "Bigger horizontal lines", value: 5, img: import.meta.env.BASE_URL + "/icons/wall_5.png" },
				{ name: "Bigger horizontal lines (inverted)", value: 6, img: import.meta.env.BASE_URL + "/icons/wall_6.png" },
				{ name: "Normal and bigger horizontal lines", value: 7, img: import.meta.env.BASE_URL + "/icons/wall_7.png" },
				{ name: "Vertical lines", value: 8, img: import.meta.env.BASE_URL + "/icons/wall_8.png" },
				{ name: "Shape (paper - hampton)", value: 9, img: import.meta.env.BASE_URL + "/icons/wall_9_1.png" },
				{ name: "Shape (love - mandy)", value: 10, img: import.meta.env.BASE_URL + "/icons/wall_9_2.png" },
				{ name: "Shape (brown - di serria)", value: 11, img: import.meta.env.BASE_URL + "/icons/wall_9_3.png" },
				{ name: "Shape (florest - chelsea cucumber)", value: 12, img: import.meta.env.BASE_URL + "/icons/wall_9_4.png" },
				{ name: "Shape (acqua - keppel)", value: 13, img: import.meta.env.BASE_URL + "/icons/wall_9_5.png" },
				{ name: "Shape (ocean - steel Blue)", value: 14, img: import.meta.env.BASE_URL + "/icons/wall_9_6.png" },
				{ name: "Shape (lava - thunderbird)", value: 15, img: import.meta.env.BASE_URL + "/icons/wall_9_7.png" },
				{ name: "Clouds", value: 16, img: import.meta.env.BASE_URL + "/icons/wall_10.png" },
				{ name: "Default", value: 17, img: import.meta.env.BASE_URL + "/icons/wall_11.png" },
				{ name: "Default", value: 18, img: import.meta.env.BASE_URL + "/icons/wall_12.png" },
				{ name: "Default", value: 19, img: import.meta.env.BASE_URL + "/icons/wall_13.png" },
				{ name: "Default", value: 20, img: import.meta.env.BASE_URL + "/icons/wall_14.png" },
				{ name: "Default", value: 21, img: import.meta.env.BASE_URL + "/icons/wall_15.png" },
				{ name: "Default", value: 22, img: import.meta.env.BASE_URL + "/icons/wall_16.png" },
				{ name: "Default", value: 23, img: import.meta.env.BASE_URL + "/icons/wall_17.png" },
				{ name: "Default", value: 24, img: import.meta.env.BASE_URL + "/icons/wall_18_1.png" },
				{ name: "Default", value: 25, img: import.meta.env.BASE_URL + "/icons/wall_18_2.png" },
				{ name: "Default", value: 26, img: import.meta.env.BASE_URL + "/icons/wall_19_1.png" },
				{ name: "Default", value: 27, img: import.meta.env.BASE_URL + "/icons/wall_19_2.png" },
				{ name: "Default", value: 28, img: import.meta.env.BASE_URL + "/icons/wall_19_3.png" },
				{ name: "Default", value: 29, img: import.meta.env.BASE_URL + "/icons/wall_20_1.png" },
				{ name: "Default", value: 30, img: import.meta.env.BASE_URL + "/icons/wall_20_2.png" },
				{ name: "Default", value: 31, img: import.meta.env.BASE_URL + "/icons/wall_20_3.png" },
				{ name: "Default", value: 32, img: import.meta.env.BASE_URL + "/icons/wall_21_1.png" },
				{ name: "Default", value: 33, img: import.meta.env.BASE_URL + "/icons/wall_21_2.png" },
				{ name: "Default", value: 34, img: import.meta.env.BASE_URL + "/icons/wall_21_3.png" },
				{ name: "Default", value: 35, img: import.meta.env.BASE_URL + "/icons/wall_21_4.png" },
				{ name: "Default", value: 36, img: import.meta.env.BASE_URL + "/icons/wall_21_5.png" },
				{ name: "Default", value: 37, img: import.meta.env.BASE_URL + "/icons/wall_21_6.png" },
				{ name: "Default", value: 38, img: import.meta.env.BASE_URL + "/icons/wall_22_1.png" },
				{ name: "Default", value: 39, img: import.meta.env.BASE_URL + "/icons/wall_22_2.png" },
				{ name: "Default", value: 40, img: import.meta.env.BASE_URL + "/icons/wall_22_3.png" },
				{ name: "Default", value: 41, img: import.meta.env.BASE_URL + "/icons/wall_22_4.png" },
				{ name: "Default", value: 42, img: import.meta.env.BASE_URL + "/icons/wall_23_1.png" },
				{ name: "Default", value: 43, img: import.meta.env.BASE_URL + "/icons/wall_23_2.png" },
				{ name: "Default", value: 44, img: import.meta.env.BASE_URL + "/icons/wall_23_3.png" },
				{ name: "Default", value: 45, img: import.meta.env.BASE_URL + "/icons/wall_24.png" },
				{ name: "Default", value: 46, img: import.meta.env.BASE_URL + "/icons/wall_25.png" },
				{ name: "Default", value: 47, img: import.meta.env.BASE_URL + "/icons/wall_26.png" },
				{ name: "Default", value: 48, img: import.meta.env.BASE_URL + "/icons/wall_27.png" },
				{ name: "Default", value: 49, img: import.meta.env.BASE_URL + "/icons/wall_28.png" },
				{ name: "Default", value: 50, img: import.meta.env.BASE_URL + "/icons/wall_29.png" },
				{ name: "Default", value: 51, img: import.meta.env.BASE_URL + "/icons/wall_30.png" },
				{ name: "Default", value: 52, img: import.meta.env.BASE_URL + "/icons/wall_31.png" },
			]}
			id="wallTexture"
			name="wallTexture"
			info="For fixed color textures, remmember to change the wall color to white for best results."
		/>
		<ColumnFields>
			<div>
				<Field
					label="Wall Height"
					placeholder="Choose the height of the wall"
					type="number"
					id="wallHeight"
					name="wallHeight"
					info="Default: 115"
				/>
			</div>
			<div>
				<Field
					label="Wall Depth"
					placeholder="Choose the depth of the wall"
					type="number"
					id="wallDepth"
					name="wallDepth"
					info="Default: 8"
				/>
			</div>
		</ColumnFields>
	</Section>

	<Separator />

	<Section
		id="data"
		title="Data Layer"
		info="Choose how the your data will be saved"
	>
		<Field
			label="Storage"
			placeholder=""
			info="Storage destination"
			type="radioImage"
			options={[
				{ name: "Local Storage", value: "local", img: import.meta.env.BASE_URL + "/icons/local_storage.png" },
				{ name: "Cloud Sync (not availabled)", value: "cloud", img: import.meta.env.BASE_URL + "/icons/cloud_sync.png", disabled: true },
			]}
			id="storageOption"
			name="storageOption"
		/>
		
		<Note>
			<Fragment slot="info">
				<p>Choosing to use <strong>local storage</strong> means that your data will be stored in the browser where the widgets are opened, and the configurations from this website will be present in the widget URL. To change the configuration you'll have to change the URL of the widget.</p>
				<p>Choosing to use <strong>cloud sync</strong> means that you will receive a new storage ID to keep your data saved in the cloud, beeing able to reuse it in any browser, at any time. Keep in mind that this ID should be private. Cloud sync is powered by Firebase Firestore.</p>
			</Fragment>
		</Note>
	</Section>

	<Separator />

	<Section
		id="preview"
		title="Preview the Result"
	>
		<Field
			label="Widget URL"
			placeholder="Use this URL in your stream"
			type="text"
			id="url"
			name="url"
			inputProps={{
				readonly: true,
				// disabled: true,
				onclick: 'this.select()',
			}}
		/>
		<iframe />
	</Section>
</OptionsLayout>


<script>
	type Reward = {
		trigger: string;
		action: string;
	};
	type FormOptions = {
		userName: string;
		userId: number;
		rewards: Reward[];
	};

	window.overlayURL = import.meta.env.BASE_URL + "/room/overlay"

	const INITIAL_OPTIONS = {
		userName: "alynva",
		userId: 155285216,
		rewards: [
			{ trigger: "Visual", action: "visual" },
			{ trigger: "Estilo", action: "estilo" },
			{ trigger: "Efeito", action: "efeito" },
			{ trigger: "Car Doggy", action: "efeito:48" },
			{ trigger: "Hap-Hop", action: "efeito:dance.1" },
			{ trigger: "Pogo Mogo", action: "efeito:dance.2" },
			{ trigger: "Duck Funk", action: "efeito:dance.3" },
			{ trigger: "Rollie", action: "efeito:dance.4" },
			{ trigger: "Dragon", action: "efeito:100" },
		],
	} as FormOptions;
	function init() {
		const form = document.querySelector("form")!;
		form.addEventListener("submit", (evt) => {
			evt.preventDefault();
			// update();
		});
		// form.addEventListener("change", update);
		// form.appendChild(buildFields(INITIAL_OPTIONS, "options"));
	}
	function buildFields(data: any, name: string) {
		const field = document.createElement("fieldset");
		if (name) {
			const legend = document.createElement("legend");
			legend.innerText = name;
			field.appendChild(legend);
		}

		if (Array.isArray(data)) {
			const input = document.createElement("input");
			input.type = "hidden";
			input.name = name;
			field.appendChild(input);
			for (const d of data) {
				field.appendChild(buildFields(d, ""));
			}
		} else {
			for (const prop in data) {
				if (["string", "number"].includes(typeof data[prop])) {
					const label = document.createElement("label");
					label.innerText = prop;
					field.appendChild(label);

					const input = document.createElement("input");
					input.type =
						typeof data[prop] === "number" ? "number" : "text";
					input.value = data[prop];
					input.name = prop;
					label.appendChild(input);
				} else {
					field.appendChild(buildFields(data[prop], prop));
				}
			}
		}
		return field;
	}

	function getCurrentData() {
		const obj = {} as FormOptions;
		const rewards = [] as Reward[];

		// Extracting userName and userId
		const userNameInput = document.querySelector(
			'input[name="userName"]'
		) as HTMLInputElement;
		const userIdInput = document.querySelector(
			'input[name="userId"]'
		) as HTMLInputElement;
		obj.userName = userNameInput.value.trim();
		obj.userId = parseInt(userIdInput.value.trim());

		// Extracting rewards
		const rewardFieldsets = document.querySelectorAll(
			"fieldset:has(input[type=hidden]) fieldset"
		);
		rewardFieldsets.forEach((fieldset) => {
			const triggerInput = fieldset.querySelector(
				'input[name="trigger"]'
			) as HTMLInputElement;
			const actionInput = fieldset.querySelector(
				'input[name="action"]'
			) as HTMLInputElement;
			rewards.push({
				trigger: triggerInput.value.trim(),
				action: actionInput.value.trim(),
			});
		});

		obj.rewards = rewards;

		return obj;
	}
	function update() {
		const data = getCurrentData();
		const params = new URLSearchParams();
		params.set("userName", data.userName);
		params.set("userId", data.userId + "");
		for (const reward of data.rewards) {
			params.set(reward.action, reward.trigger);
		}

		const url =
			window.location.origin +
			import.meta.env.BASE_URL +
			"/chat-room/overlay?" +
			params.toString();
		// document.querySelector("iframe")!.src = url;
		// document.querySelector("pre code")!.innerHTML = url;
	}

	init();
	update();
</script>
